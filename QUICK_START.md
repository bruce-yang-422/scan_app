# 快速開始指南

## 📋 前置準備

### 1. 準備 Google Sheet

#### 建立 Sheet

1. 建立一個 Google Sheet
2. 第一行設定為標題行（欄位名稱）
3. 從第二行開始填入資料

#### 欄位順序（固定）

| 欄位       | 說明                                 | 必填 | 範例           |
| ---------- | ------------------------------------ | ---- | -------------- |
| 來源名稱   | 來源名稱（可自由設定，如分店、供應商等） | 否   | 台北一店、供應商A |
| 訂單日期   | 訂單日期（支援多種格式，自動正規化） | 是   | 2025-12-22     |
| 訂單編號   | 訂單編號                             | 是   | ORD001         |
| 物流公司   | 物流公司名稱                         | 否   | 黑貓           |
| 物流單號   | 物流單號（掃描 Key）                 | 是   | SHIP001        |
| 備註       | 額外說明                             | 否   | 急件           |

**訂單日期格式說明**：
- 系統支援多種日期格式，會自動正規化為 `YYYY-MM-DD`
- 支援格式包括：
  - `YYYY-MM-DD`、`YYYY/MM/DD`
  - `MM/DD/YYYY`、`DD/MM/YYYY`
  - `YYYY年MM月DD日`
  - Google Sheets Date 型別（自動轉換）
  - 其他常見日期格式

#### 設定公開權限

1. 點擊右上角「共用」按鈕
2. 選擇「知道連結的使用者」
3. 設定權限為「檢視者」
4. 複製連結

#### 範例格式

```csv
來源名稱,訂單日期,訂單編號,物流公司,物流單號,備註
台北一店,2025-12-22,ORD001,黑貓,SHIP001,
供應商A,2025-12-22,ORD002,新竹物流,SHIP002,急件
,2025-12-23,ORD003,,SHIP003,
```

---

## 🚀 使用步驟

### Step 1: 匯入批次

1. **打開 App**
   - 啟動 App，進入 Batch 列表頁面

2. **點擊匯入按鈕**
   - 點擊頁尾「匯入」按鈕

3. **選擇或輸入 Google Sheet 連結**
   - 可從下拉選單選擇已儲存的來源 URL
   - 或在輸入框中貼上 Google Sheet 的公開連結
   - 可輸入連結備註（來源名稱可自由設定，如分店、供應商等）並儲存 URL，方便下次使用

4. **匯入資料**
   - 點擊「匯入資料」按鈕
   - 等待匯入完成（會顯示進度）

5. **確認匯入結果**
   - 顯示「匯入成功！共 X 筆資料（略過 Y 筆無效資料）」
   - 自動進入該 Batch 的掃描頁面
   - 可以直接開始掃描

**注意事項**：
- Google Sheet 必須設定為公開（知道連結的使用者都可以查看）
- 確保 Sheet 包含所有必要欄位
- 訂單日期支援多種格式（會自動正規化為 `YYYY-MM-DD`）
- 第一行必須是標題行

**重要說明**：
- Google Sheets 可同時包含數個過去日期尚未完成出貨的訂單資料
- 系統於匯入時，會依據訂單日期自動分批管理（每個 `{store_name}_{order_date}` 為一個 Batch）
- Google Sheets 視為**最近數日的待處理工作清單**，而非歷史最終依據
- **實際出貨結果以掃描完成後產生之匯出報告為準**
- 匯出報告（TXT/JSON）才是最終的出貨記錄，包含實際掃描時間、狀態等資訊

**重要說明**：
- Google Sheets 可同時包含數個過去日期尚未完成出貨的訂單資料
- 系統於匯入時，會依據訂單日期自動分批管理（每個 `{store_name}_{order_date}` 為一個 Batch）
- Google Sheets 視為**最近數日的待處理工作清單**，而非歷史最終依據
- **實際出貨結果以掃描完成後產生之匯出報告為準**
- 匯出報告（TXT/JSON）才是最終的出貨記錄，包含實際掃描時間、狀態等資訊

---

### Step 2: 開始掃描

1. **選擇 Batch 或總出貨模式**
   - **單一 Batch 掃描**：在 Batch 列表頁面，點擊要掃描的 Batch
   - **總出貨模式**：點擊頁尾「總出貨」按鈕，可跨多個來源同時掃描

2. **進入掃描頁面**
   - 顯示該 Batch（或所有未完成 Batch）的所有訂單項目
   - 分類顯示：待掃描、已掃描、錯誤
   - 總出貨模式會顯示每個項目所屬的來源名稱

3. **選擇輸入模式**
   - **掃描槍模式**：自動聚焦，掃描後自動送出（適合快速連續掃描）
     - 掃描槍輸入後會自動檢測並提交（300ms 延遲，無需按回车）
     - 每次掃描都會自動輸入並處理
   - **相機模式**：使用相機掃描條碼（適合沒有掃描槍的情況）
     - 相機初始化帶有錯誤處理和重試機制，確保穩定運行
     - 狀態顯示欄位位於列表上方，不遮擋掃描區域
   - **手動輸入模式**：手動輸入物流單號，點擊「送出」按鈕
     - 輸入框會監聽文字變化，自動啟用送出按鈕

4. **掃描物流單號**
   - 掃描或輸入物流單號
   - 輸入欄位下方會即時顯示狀態：
     - ✅ **成功**（綠色）：首次掃描成功
     - ⚠️ **重複**（橙色）：重複掃描
     - ❌ **無此資料**（紅色）：不在清單內
   - 狀態顯示時間可設定（預設 2 秒）

5. **查看掃描結果**
   - 列表會即時更新
   - 可為掃描項目新增或編輯備註（點擊項目右側選單）
   - 每個項目會顯示訂單日期（小字）

6. **繼續掃描**
   - 掃描槍模式：掃描後自動清空輸入框並重新聚焦，可連續快速掃描
   - 相機模式：掃描後自動重新啟動相機
   - 快速連續掃描時，狀態會立即切換到最新結果

---

### Step 3: 匯出結果

1. **確認掃描完成**
   - 檢查是否還有待掃描項目
   - 查看統計資訊（已掃描/總筆數）

2. **點擊匯出按鈕**
   - 在掃描頁面頁尾，點擊「匯出」按鈕
   - 已完成批次可點擊「重新匯出」按鈕

3. **確認匯出**
   - 系統會顯示確認對話框
   - 提醒：首次匯出後此批次將標記為已完成
   - 點擊「確定」繼續

4. **等待匯出完成**
   - 系統會同時產生 TXT 和 JSON 檔案
   - 檔案儲存在 `reports/store={store_name}/order_date={order_date}/` 目錄
   - 檔名時間戳記使用設定的時區時間
   - 匯出檔案包含掃描人員資訊（如果已設定）

5. **選擇操作**
   - **複製 TXT 內容**：複製到剪貼簿，可直接貼到 LINE
   - **分享 TXT**：分享 TXT 檔案
   - **分享 JSON**：分享 JSON 檔案
   - 透過分享選單選擇目標應用：
     - **Line**：分享到 Line 聊天
     - **Google Drive**：上傳到雲端硬碟
     - **Email**：透過郵件發送
     - 或其他支援的應用程式

6. **查看已完成批次**
   - 已完成批次會保留在列表中（變灰顯示）
   - 可點擊查看詳細資訊
   - 可長按刪除已完成批次
   - 可重新匯出

---

### Step 4: 系統設定（選用）

1. **進入設定頁面**
   - 在 Batch 列表頁面，點擊右上角「設定」按鈕（齒輪圖示）
   - 會顯示半頁設定面板

2. **設定個資**
   - 輸入掃描人員姓名
   - 輸入掃描人員編號/ID
   - 此資訊會包含在匯出的 TXT 和 JSON 檔案中

3. **掃描設定**
   - **狀態顯示時間**：調整滑桿設定 0-5 秒（所有狀態共用）
   - **掃描成功震動**：切換開關控制是否震動
   - **掃描成功聲音（逼聲）**：切換開關控制是否播放提示音

4. **時區資訊**
   - 固定為 UTC+8 (Asia/Taipei)，僅顯示不可編輯
   - 系統內部使用 UTC 時間儲存（標準時間）
   - 前端顯示與匯出資料均轉換為 UTC+8 (Asia/Taipei)，並於欄位或檔名標示時區
   - 系統時間已從國際標準時間伺服器同步

5. **顯示模式**
   - 可選擇自動（建議）、深色（高對比）、淺色（室內）
   - 深色模式適合戶外強光環境
   - 淺色模式適合室內環境

6. **APP 資訊**
   - 查看應用程式名稱和版本號
   - 查看系統說明

7. **隱私政策**
   - 查看資料儲存、使用和保留說明

8. **資料管理**
   - 可清空所有資料（批次、掃描記錄、匯出檔案）

**設定說明**：
- 所有設定會立即生效並自動儲存
- 系統內部使用 UTC 時間儲存（標準時間）
- 匯入匯出時會自動轉換為設定的時區時間
- 預設時區為 UTC+8 台北

---

## 🔧 常見問題

### Q1: 匯入失敗，顯示「資料格式不正確」？

**A:** 請確認：
1. 第一行是標題行
2. 欄位順序正確：來源名稱、訂單日期、訂單編號、物流公司、物流單號、備註
3. 訂單日期格式正確（支援多種格式，會自動正規化）
4. 訂單編號和物流單號欄位不為空

**日期格式支援**：
- 系統會自動解析多種日期格式並正規化為 `YYYY-MM-DD`
- 如果日期無法解析，該筆資料會被跳過（不會寫入資料庫，不會計入匯入筆數）
- 建議使用標準格式：`YYYY-MM-DD` 或 `YYYY/MM/DD`

### Q2: 匯入失敗，顯示「無法下載資料」？

**A:** 請確認：
1. Google Sheet 已設定為公開（知道連結的使用者都可以查看）
2. 網路連線正常
3. Sheet 連結格式正確（應為 `https://docs.google.com/spreadsheets/d/...`）

### Q3: 掃描時顯示「INVALID（不在清單內）」？

**A:** 可能原因：
1. 物流單號輸入錯誤（注意大小寫、空格）
2. 該物流單號尚未匯入
3. 掃描的 Batch 與該物流單號所屬的 Batch 不同

**解決方法**：
- 確認物流單號是否正確
- 檢查是否在正確的 Batch 中掃描
- 重新匯入最新的 Google Sheet

**技術說明**：
- `INVALID` 狀態不會寫入資料庫，僅在 UI 顯示
- 匯出報告中不會包含 `INVALID` 記錄（因為它們不在 `scan_items` 表中）
- 此設計確保資料庫僅儲存「預期出貨清單」，避免誤掃記錄污染資料

### Q4: 如何查看掃描進度？

**A:** 
- 在 Batch 列表頁面可以看到每個 Batch 的進度條
- 點擊 Batch 進入掃描頁面，可以看到詳細的分類列表：
  - 待掃描（橙色）
  - 已掃描（綠色）
  - 錯誤（紅色，包含重複和無效）

### Q5: 匯出後可以再修改嗎？

**A:** 
- **不可以**。匯出後 Batch 會標記為已完成（finished_at），無法再修改或重新匯入
- 如果需要修改，請在匯出前確認所有掃描都正確
- 如果尚未匯出，可以重新匯入同一個 Batch：
  - 新匯入的資料會覆蓋相同物流單號的舊記錄（狀態重置為待掃描）
  - 不在新列表中的舊記錄會保留在資料庫中
  - Batch 資訊會更新

### Q6: 如何清理舊資料？

**A:**
- App 會在啟動時自動清理 7 天前的已完成 Batch
- 清理條件：`order_date < today - 7 days` 且 `finished_at IS NOT NULL`
- 未完成的 Batch 不會被清理

### Q7: 可以同時管理多個 Batch 嗎？

**A:**
- **可以**。系統支援多個 Batch 同時存在
- 每個 Batch 獨立管理（來源名稱 + 訂單日期，來源名稱可自由設定）
- 可以在 Batch 列表頁面查看所有未完成的 Batch

### Q8: 如何設定系統設定？

**A:**
1. 在 Batch 列表頁面，點擊右上角「設定」按鈕（齒輪圖示）
2. 會顯示半頁設定面板，包含：
   - **設定個資**：掃描人員姓名和編號/ID
   - **掃描設定**：狀態顯示時間、震動、聲音
   - **時區資訊**：顯示時區設定（固定為 UTC+8）
   - **顯示模式**：選擇自動、深色、淺色
   - **APP 資訊**：查看應用程式資訊
   - **隱私政策**：查看隱私說明
   - **資料管理**：清空所有資料

**設定說明**：
- 所有設定會立即生效並自動儲存（顯示模式需重新啟動應用程式）
- 系統內部使用 UTC 時間儲存（標準時間）
- 前端顯示與匯出資料均轉換為 UTC+8 (Asia/Taipei)，並於欄位或檔名標示時區
- 時區固定為 UTC+8 (Asia/Taipei)，不可編輯
- 系統時間已從國際標準時間伺服器同步

### Q9: 什麼是總出貨模式？

**A:**
- 總出貨模式允許跨多個來源同時掃描
- 適合倉庫人員一次處理多個來源的訂單
- 掃描時自動在所有未完成的 Batch 中查找
- 顯示掃描結果時會標示所屬來源
- 可一次匯出所有 Batch 的結果

### Q10: 匯出後可以再修改嗎？

**A:**
- **可以查看和重新匯出**：已完成批次會保留在列表中（變灰顯示），可點擊查看詳細資訊，也可重新匯出
- **無法再掃描**：已完成批次無法再進行掃描操作
- **可以刪除**：長按已完成批次可刪除該批次

### Q11: 如何批次更新資料？

**A:**
1. 在 Batch 列表頁面，點擊頁尾「批次更新」按鈕
2. 選擇「更新所有來源」或「選擇單一來源」
3. 系統會從已儲存的 URL 下載最新資料並更新
4. 顯示更新結果（成功/失敗統計）

**注意**：已完成的批次不會被更新

---

## 💡 使用技巧

### 1. 批量掃描
- 使用掃描槍模式可快速連續掃描
- 掃描槍輸入後自動檢測並提交（300ms 延遲，無需按回车）
- 掃描後自動清空輸入框並重新聚焦
- 適合大量訂單的掃描作業
- 快速連續掃描時，狀態會立即切換到最新結果

### 2. 跨日掃描
- 今天可以掃描昨天或前天的訂單
- 系統會根據訂單日期自動分組
- 每個 Batch 獨立顯示進度

### 3. 總出貨模式
- 適合倉庫人員一次處理多個來源的訂單
- 掃描時自動在所有未完成的 Batch 中查找
- 顯示掃描結果時會標示所屬來源
- 可一次匯出所有 Batch 的結果

### 4. URL 記憶功能
- 匯入時可儲存來源對應的 Google Sheet URL（來源名稱可自由設定，如分店、供應商等）
- 可自由設定連結備註，方便識別
- 下次匯入時可直接從下拉選單選擇
- 方便快速匯入和批次更新

### 5. 結果檢查
- 匯出前檢查「未掃描清單」
- 確認所有訂單都已掃描完成
- 查看錯誤項目（重複或無效）
- 可為掃描項目新增備註

### 6. 資料備份
- 定期匯出結果備份
- TXT 格式適合閱讀和 LINE 傳送（可複製內容）
- JSON 格式適合程式處理和留存
- 已完成批次會保留在列表中，可重新匯出

### 7. 批次更新
- 定期使用批次更新功能更新所有來源資料
- 已儲存的 URL 會自動更新
- 已完成的批次不會被更新

---

## 📱 操作流程圖

```text
啟動 App
  ↓
Batch 列表頁面
  ↓
[點擊匯入] → 匯入新批次 → 自動進入掃描頁面
  ↓
[點擊 Batch] 或 [點擊總出貨] → 掃描頁面
  ↓
選擇輸入模式（掃描槍/相機/手動） → 掃描物流單號 → 查看即時狀態
  ↓
[點擊匯出] → 確認匯出 → 產生檔案 → 選擇操作（複製/分享 TXT/分享 JSON）
  ↓
返回 Batch 列表（已完成批次變灰顯示，可查看和重新匯出）
  ↓
[點擊設定] → 半頁設定面板（個資/掃描設定/時區/APP資訊/隱私政策/資料管理）
  ↓
[點擊批次更新] → 更新所有來源或單一來源
```

---

## 🔄 更新資料

當 Google Sheet 有新的訂單資料時：

1. 重新匯入同一個 Batch（使用相同的 Google Sheet 連結）
2. 系統會覆蓋舊資料
3. 已掃描的狀態會保留（如果物流單號相同）

**注意**：重新匯入會覆蓋所有現有資料，請確保 Sheet 包含所有需要的訂單資料。

---

## 📋 Google Sheets 使用理念

### 設計原則

**Google Sheets 的角色**：
- Google Sheets 視為**最近數日的待處理工作清單**
- 可同時包含數個過去日期尚未完成出貨的訂單資料
- 系統會依據訂單日期自動分批管理，每個 `{store_name}_{order_date}` 為一個 Batch

**實際運作**：
- 匯入時，系統自動將不同日期的訂單分組到不同的 Batch
- 同一來源、不同日期的訂單會分開管理，各自有獨立的掃描進度
- 可以同時存在多個未完成的 Batch（例如：12/20、12/21、12/22 的訂單）
- 每個 Batch 獨立掃描、獨立匯出
- 來源名稱可自由設定（如分店、供應商、或其他任何名稱）

**最終依據**：
- **實際出貨結果以掃描完成後產生之匯出報告為準**
- 匯出報告（TXT/JSON）包含：
  - 實際掃描時間（非 Sheet 中的訂單日期）
  - 實際掃描狀態（成功、重複、未掃描等）
  - 掃描人員資訊
  - 完整的出貨記錄
- Google Sheets 僅作為「待處理清單」的來源，**最終出貨記錄以匯出報告為準**

### 使用建議

1. **定期更新 Sheet**：將最近數日尚未完成出貨的訂單資料放在 Sheet 中
2. **批次匯入**：系統會自動依據訂單日期分批管理
3. **掃描完成後匯出**：匯出報告才是最終的出貨記錄
4. **保留匯出報告**：建議保留匯出的 TXT/JSON 檔案作為最終出貨記錄

---

## 📞 技術支援

如有問題，請聯繫開發團隊。
